<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<title>Bigscreen</title>

	<script src="http://10.0.0.1/lib/spaceifyinitialize.js"></script>						<!-- Use Spaceify's classes. Wait for spaceifyReady event! -->

	<script src="language.js"></script>
	<link href="index.css" rel="stylesheet" type="text/css" media="screen">

	<script type="text/javascript">
		//document.domain = window.location.hostname;											// Same Origin Policy, pages loaded to bigscreen_if have the same domain

		var bs_id = "default";
		var bigScreen = null;

		/*****************
		* DOM AND EVENTS *
		*****************/
		window.addEventListener("spaceifyReady", function()
		{
			bigScreen = new BigScreen();
			bigScreen.resize(document.getElementById("bigscreen_if"));
			bigScreen.initialize();
		});

		window.addEventListener("resize", function()
		{
			if(bigScreen)
				bigScreen.resize(document.getElementById("bigscreen_if"));
		}, false);

		/************
		* BigScreen *
		*************/
		function BigScreen()
		{
			var self = this;

			var timeOut = null;

			var bs_service = null;
			var content_type = "";

			var bs_service_name = "spaceify.org/services/bigscreen";

			var network = new SpaceifyNetwork();
			var services = new SpaceifyService();
			var utility = new SpaceifyUtility();

			var MESSAGE_TIMEOUT = 5;
			var RECONNECT_TIMEOUT = 10 * 1000;

			self.initialize = function()
			{
				var getobj = network.parseGET(window.location.href);								// Big screen id can be defined in URL
				bs_id = ("bs_id" in getobj ? getobj.bs_id : "default");

				connect();
			}

			var connect = function()
			{
				services.connectService(bs_service_name, false, function(err, service)
				{
					if(err)
						disconnectionListener(bs_service_name);
					else
					{
						showMessage(language.CONNECTED, MESSAGE_TIMEOUT);

						bs_service = service;														// Remember the returned service connection

						services.setDisconnectionListener(bs_service, disconnectionListener);		// Try to reconnect if connection is lost

						bs_service.exposeMethod("loadContent", self, loadContent);					// Other pages can change the url by calling this method

						bs_service.callRPC("bigScreenConnect", [bs_id], null, null);				// Notify big screen 
					}
				});
			}

			var disconnectionListener = function(service_name)
			{
				var err = services.getError(service_name);
				if(bs_service)
					showMessage(language.E_CONNECTION_LOST, MESSAGE_TIMEOUT);
				else if(err)
					showMessage(utility.combineErrors(language.E_CONNECTION_FAILED, err), MESSAGE_TIMEOUT);

				bs_service = null;																	// Reset

				if((bigscreenif = document.getElementById("bigscreen_if")) != null)
					bigscreenif.src = "";

				window.setTimeout(connect, RECONNECT_TIMEOUT);										// Try to reconnect
			}
	
			var loadContent = function(_content_url, _content_type)
			{ // Load new content page to this big screen, if content is not already loaded.
				if(content_type != _content_type || !_content_type)
				{
					content_type = _content_type;
					document.getElementById("bigscreen_if").src = _content_url;
				}

				return 1;
			}

			self.resize = function(obj)
			{
				if(obj)
				{
					obj.style.width = (window.innerWidth) + "px";
					obj.style.height = (window.innerHeight) + "px";
				}
			}

			var showMessage = function(err, time)
			{
				var errstr = utility.errorsToString(err);

				if((div = document.getElementById("message_div")) == null)
					return;

				while(div.firstChild)
					div.removeChild(div.firstChild);

				var text = document.createTextNode(errstr);
				div.appendChild(text);

				div.style.display = "inline";

				if(time != -1)
				{
					if(timeOut != null) clearTimeout(timeOut);
					timeOut = setTimeout(function() { div.style.display = "none"; timeOut = null; }, time * 1000);
				}

				console.log(errstr);
			}

		}
	</script>
</head>

<body>
	<div id="message_div" class="messagediv"></div>
	<iframe id="bigscreen_if" src="" class="bigscreeniframe" scrolling="no" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
</body>

</html>
