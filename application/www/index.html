<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<title>Bigscreen</title>

	<script src="http://10.0.0.1//js/jquery-1.11.3.min.js"></script>
	<script src="http://10.0.0.1/libs/spaceifyinitialize.js"></script>						<!-- Use Spaceify's classes. Wait for spaceifyReady event! -->

	<script src="language.js"></script>
	<link href="index.css" rel="stylesheet" type="text/css" media="screen">

	<script type="text/javascript">
		var bigscreenId = "default";
		var bigScreen = null;

			// DOM AND EVENTS -- -- -- -- -- -- -- -- -- -- //
		window.addEventListener("spaceifyReady", function()
			{
			var getobj = new SpaceifyNetwork().parseGET(window.location.href);					// Big screen id can be passed in the URL
			bigscreenId = ("bigscreenId" in getobj ? getobj.bigscreenId : "default");

			bigScreen = new BigScreen();
			bigScreen.resize();
			bigScreen.connect();
			});

		window.addEventListener("resize", function()
			{
			if(bigScreen)
				bigScreen.resize();
			}, false);

			// BigScreen -- -- -- -- -- -- -- -- -- -- //
		function BigScreen()
			{
			var self = this;

			var timeOut = null;
			var contentType = "";
			var isInitialized = false;
			var service_name = "spaceify.org/services/bigscreen";

			var config = new SpaceifyConfig();
			var utility = new SpaceifyUtility();
			var services = new SpaceifyService();

			var MESSAGE_TIMEOUT = 5 * 1000;
			var RECONNECT_TIMEOUT = 10 * 1000;

				// CONNECTION -- -- -- -- -- -- -- -- -- -- //
			self.connect = function()
				{
				services.connectService(service_name, function(err, service)
					{
					if(service && service.getStatus() == config.CONNECTED)
						{
						if(!isInitialized)
							{ // Same service object is used even after disconnection and there is no need to initialize it more than once.
							isInitialized = true;
							service.setDisconnectionListener(reconnectService);
							service.exposeRpcMethod("loadContent", self, loadContent);
							}

						showMessage(language.CONNECTED);
						service.callRpc("bigScreenConnect", [bigscreenId], null, null);
						}						
					else
						reconnectService(service);
					});
				}

			var reconnectService = function(service)
				{
				var status = (service ? service.getStatus() : config.CONNECTION_UNINITIALIZED);

				if(status == config.CONNECTION_LOST)
					showMessage(language.E_CONNECTION_LOST);
				else if(status == config.CONNECTION_UNINITIALIZED)
					showMessage(language.E_CONNECTION_UNINITIALIZED);
				else if(status == config.CONNECTION_FAILED)
					showMessage(utility.combineErrors(language.E_CONNECTION_FAILED, service.getError()));

				$("#bigscreen_if").attr("src", "")

				window.setTimeout(self.connect, RECONNECT_TIMEOUT);										// Try to reconnect
				}

				// EXPOSED RPC METHODS -- -- -- -- -- -- -- -- -- -- //
			var loadContent = function(url, type)
				{
				// Load new content page to this big screen. If type doesn't change, the same page is used.
				if(contentType != type || !type)
					{
					contentType = type;
					$("#bigscreen_if").attr("src", url);
					}
				}

				// -- -- -- -- -- -- -- -- -- -- //
			self.resize = function()
				{
				if((obj = $("#bigscreen_if")).length > 0)
					{
					obj.width($(window).innerWidth())
					obj.height($(window).innerHeight())
					}
				}

			var showMessage = function(err)
				{
				var errstr = utility.errorsToString(err);

				$("#message_div").empty().append($.parseHTML(errstr)).show();

				if(timeOut != null)
					{
					clearTimeout(timeOut);
					timeOut = null;
					}

				timeOut = setTimeout(function()
					{
					timeOut = null;
					$("#message_div").hide();
					}, MESSAGE_TIMEOUT);

				console.log(errstr);
				}

			}
	</script>
</head>

<body>
	<div id="message_div" class="messagediv"></div>
	<iframe id="bigscreen_if" src="" class="bigscreeniframe" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
</body>

</html>
